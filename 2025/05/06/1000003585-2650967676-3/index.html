<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="GPT-4o图像生成的「核燃料」找到了！万字长文拆解潜在变量，网友：原来AI在另一个维度作画, ZejunCao&#39;Blogs">
    <meta name="description" content="GPT-4o图像生成的「核燃料」找到了！万字长文拆解潜在变量，网友：原来AI在另一个维度作画

仅用于站内搜索，没有排版格式，具体信息请跳转上方微信公众号内链接

选自SanderDieleman博客机器之心编译编辑：刘欣上个月，GPT-4">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>GPT-4o图像生成的「核燃料」找到了！万字长文拆解潜在变量，网友：原来AI在另一个维度作画 | ZejunCao&#39;Blogs</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    


    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    
        <link rel="stylesheet" type="text/css" href="/css/reward.css">
    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 7.3.0"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">ZejunCao&#39;Blogs</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">ZejunCao&#39;Blogs</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/frontcover/1000003585_2650967676_3.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">GPT-4o图像生成的「核燃料」找到了！万字长文拆解潜在变量，网友：原来AI在另一个维度作画</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/%E6%9C%BA%E5%99%A8%E4%B9%8B%E5%BF%83/">
                                <span class="chip bg-color">机器之心</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2025-05-06
                </div>
                

                

                

                

                
            </div>
        </div>
        <hr class="clearfix">

        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/qVFKYW7yIRvZgNKRVoxobw">GPT-4o图像生成的「核燃料」找到了！万字长文拆解潜在变量，网友：原来AI在另一个维度作画</a></p>
<blockquote>
<p>仅用于站内搜索，没有排版格式，具体信息请跳转上方微信公众号内链接</p>
</blockquote>
<p>选自SanderDieleman博客<br>机器之心编译<br>编辑：刘欣<br>上个月，GPT-4o的图像生成功能爆火，掀起了以吉卜力风为代表的广泛讨论，生成式AI的热潮再次席卷网络。<br>而在这股浪潮背后，潜在空间（LatentSpace）作为生成模型的核心驱动力，点燃了图像与视频创作的无限想象。<br>知名研究者AndrejKarpathy最近转发了一篇来自GoogleDeepMind研究科学家SanderDielman的博客文章，探讨了生成模型（如图像、音频和视频生成模型）如何通过利用潜在空间来提高生成效率和质量。<br>博客链接：https :&#x2F;&#x2F;sander.ai&#x2F;2025&#x2F;04&#x2F;15&#x2F;latents.html</p>
<p>在这篇文章中，他将潜在变量比喻为「数据的精髓」——通过压缩复杂信息实现图像、语音等生成。他还深入对比变分自编码器（VAEs）、生成对抗网络（GANs）和扩散模型，展示了潜在变量如何支持这些模型生成逼真内容。<br>例如，Dielman参与开发的WaveNet就利用潜在变量成功实现了高质量语音合成，并在谷歌多个产品中得到广泛应用。他还以VQ-VAE为例，说明离散潜在空间如何提升图像生成效率。<br>这篇文章兼具理论深度与直观洞察，适合对生成模型感兴趣的读者深入研究。<br>配方<br>在潜在空间中训练生成模型通常分为两个阶段：<br>1.用输入信号训练自编码器。自编码器是一个神经网络，包含两个子网络：编码器和解码器。编码器将输入信号映射到相应的潜在表征（编码），解码器则将潜在表征映射回输入域（解码）。<br>2.在潜在表征上训练生成模型。这一步骤涉及使用第一阶段的编码器来提取训练数据的潜在表征，然后直接在这些潜在表征上训练生成模型。当前主流的生成模型通常是自回归模型或扩散模型。<br>一旦第一阶段训练好了自编码器，在第二阶段其参数将不再改变：学习过程第二阶段的梯度不会反向传播到编码器中。换句话说，在第二阶段，编码器的参数会被冻结。<br>请注意，在训练的第二阶段，自编码器的解码器部分不发挥作用，但在从生成模型采样时需要用到它，因为这将生成潜在空间中的输出。解码器使我们能够将生成的潜在向量映射回原始输入空间。<br>下面是说明这种两阶段训练方法的示意图。在相应阶段学习参数的网络标有「∇」符号，因为这几乎总是使用基于梯度的学习方法。参数被冻结的网络标有雪花符号。<br>潜在生成模型的训练方法：两阶段训练。<br>在两个训练阶段中涉及几种不同的损失函数，这在图中以红色标出：<br>为确保编码器和解码器能够高保真地将输入表征转换为潜在向量再转换回来，多个损失函数用于约束重建（解码器输出）与输入的关系。这些通常包括简单的回归损失、感知损失和对抗损失。<br>为了限制潜在向量的容量，在训练期间通常会直接对它们应用额外的损失函数，尽管并非总是如此。我们将此称为瓶颈损失，因为潜在表征在自编码器网络中形成了一个瓶颈。<br>在第二阶段，生成模型使用其自身的损失函数进行训练，这与第一阶段使用的损失函数分开。这通常是负对数似然损失（用于自回归模型）或扩散损失。<br>深入观察基于重建的损失函数，我们有以下几种：<br>回归损失：有时是在输入空间（例如像素空间）中测量的平均绝对误差（MAE），但更常见的是均方误差（MSE）。<br>感知损失：形式多样，但通常利用另一个冻结的预训练神经网络来提取感知特征。该损失函数鼓励重建和输入之间的这些特征相匹配，从而更好地保留回归损失大多忽视的高频内容。对于图像处理，LPIPS是一种流行的选择。<br>对抗损失：使用与自编码器协同训练的判别网络，类似于生成对抗网络（GAN）的方法。判别网络负责区分真实输入信号和重建信号，而自编码器则努力欺骗判别网络使其出错。目的是提高输出的真实性，即使这意味着进一步偏离输入信号。在训练开始时，通常会暂时禁用对抗损失，以避免训练过程中的不稳定。<br>以下是一个更详细的示意图，展示了第一阶段的训练过程，并明确显示了在此过程中通常发挥作用的其他网络。<br>这是第一训练阶段的更详细版本的图，展示了所有参与的网络。<br>不言而喻，这个通用方法在音频和视频等应用中常常会有各种变体，但我试图总结出在大多数现代实际应用中常见的主要元素。<br>我们是如何走到这一步的<br>如今，自回归和扩散模型这两种主要的生成模型范式，最初都是应用于「原始」数字感知信号的，即像素（pixels）与波形（waveforms）。例如，PixelRNN和PixelCNN是逐像素生成图像的，而WaveNet和SampleRNN则是逐样本生成音频波形的。在扩散模型方面，最初引入和建立这种建模范式的作品都是通过像素来生成图像的，早期的研究如WaveGrad和DiffWave则是通过生成波形来产生声音的。<br>然而，人们很快意识到这种策略在扩展性方面存在很大挑战。其主要原因可以概括为：感知信号大多由不可察觉的噪声组成。换句话说，在给定信号的总信息量中，只有一小部分真正影响我们的感知。因此，确保我们的生成模型能够高效利用其容量，并专注于建模这一小部分信息是非常重要的。这样，我们就可以使用更小、更快且更便宜的生成模型，同时不牺牲感知质量。<br>潜在自回归模型<br>随着具有里程碑意义的VQ-VAE论文的发表，图像自回归模型取得了巨大飞跃。该论文提出了一种实用策略，通过在自编码器中插入矢量量化瓶颈层，利用神经网络学习离散表征。为了学习图像的离散潜在表征，一个具有多个下采样阶段的卷积编码器生成了一个矢量的空间网格，其分辨率比输入图像低4倍（在高度和宽度上均为输入图像的1&#x2F;4，因此空间位置减少了16倍），然后这些矢量通过瓶颈层进行量化。<br>现在，我们可以使用类似PixelCNN的模型一次生成一个潜在向量，而不是逐像素生成图像。这显著减少了所需的自回归采样步骤数量，但更重要的是，在潜在空间而不是像素空间中测量似然损失，有助于避免在不可察觉的噪声上浪费模型容量。这实际上是一种不同的损失函数，更侧重于感知相关的信号内容，因为许多感知无关的信号内容在潜在向量中并不存在（关于这个问题，可以参阅我在典型性方面的博客文章）。该论文展示了从在ImageNet上训练的模型生成的128×128图像，这种分辨率在当时只有GANs才能达到。<br>离散化对于其成功至关重要，因为当时的自回归模型在离散输入下表现更好。但或许更重要的是，潜在表征的空间结构使得现有的基于像素的模型可以非常容易地进行适配。在此之前，变分自编码器（VAEs）通常会将整个图像压缩到一个单一的潜在向量中，导致表征没有任何拓扑结构。现代潜在表征的网格结构与「原始」输入表征的网格结构相镜像，生成模型的网络架构利用这种结构来提高效率（例如，通过卷积、循环或注意力层）。<br>VQ-VAE2进一步将分辨率提高到256×256，并通过扩大规模和使用多层次的潜在网格（以层次化结构组织）显著提升了图像质量。随后，VQGAN将GANs的对抗学习机制与VQ-VAE架构相结合。这使得分辨率降低因子从4倍增加到16倍（与像素输入相比，空间位置减少了256倍），同时仍然能够生成锐利且逼真的重建图像。对抗损失在其中发挥了重要作用，即使无法紧密遵循原始输入信号，也能鼓励生成逼真的解码器输出。<br>VQGAN成为近五年来我们在感知信号生成建模方面取得快速进展的核心技术。其影响怎么强调都不为过——我甚至可以说，这可能是GANs在2024年NeurIPS大会上获得「时间考验奖」的主要原因。VQGAN论文提供的「助攻」，使GANs即使在被扩散模型几乎完全取代用于媒体生成的基础任务之后，依然保持着相关性。<br>值得一提的是，上一节中提到的许多方法在这个论文中都被构思出来了。如今，迭代生成器通常不是自回归的（Parti、xAI最近的Aurora模型以及OpenAI的GPT-4o是显著例外），量化瓶颈也被替代了，但其他一切都还在。尤其是简单的回归损失、感知损失和对抗损失的组合，尽管看似复杂，却一直顽固地存在。在快速发展的机器学习领域，这种持久性极为罕见——也许只有基本未变的Transformer架构和Adam优化器能与之媲美！<br>（虽然离散表征在使潜在自回归模型在大规模应用中发挥作用方面至关重要，但我想指出，最近连续空间中的自回归模型也取得了良好的效果。）<br>潜在扩散<br>随着潜在自回归模型在2010年代后期逐渐崭露头角，以及扩散模型在2020年代初期取得突破，将这两种方法的优势相结合成为了顺理成章的下一步。如同许多应运而生的想法一样，我们在2021年下半年见证了一系列探讨这一主题的论文在arXiv上接连发布。其中最为人熟知的是Rombach等人的《High-ResolutionImageSynthesiswithLatentDiffusionModels》，他们沿用了先前的VQGAN研究成果，并将自回归Transformer换成基于UNet的扩散模型，这一成果构成了稳定扩散模型的基础。其他相关工作虽然规模较小，或者针对的是非图像类数据，但也进行了类似探索。<br>这种方法主流化花了点时间。早期商业文生图模型使用所谓分辨率级联，即基础扩散模型直接在像素空间生成低分辨率图像，一个或多个上采样扩散模型则基于低分辨率输入生成高分辨率输出。典型例子包括DALL-E2和Imagen2。稳定扩散模型问世后，大多转为基于潜在空间的方法（包括DALL-E3和Imagen3）。<br>自回归模型和扩散模型一个关键区别在于训练所用的损失函数。自回归模型训练相对简单，最大化似然即可（尽管也曾尝试过其他方法）。扩散模型则复杂些，其损失函数是针对所有噪声级别的期望，这些噪声级别的相对权重显著影响模型学习内容。这为将典型的扩散损失解释为一种感知损失函数提供了依据，这种损失函数更强调在感知上更为显著的信号内容。<br>初看之下，这会让两阶段方法显得多余，因其与扩散损失函数的方式类似，即过滤掉感知无关信号内容，避免浪费模型容量。但实际中这两种机制相当互补，原因如下：<br>小尺度和大尺度下的感知工作机制似乎有根本区别，尤其是视觉领域。例如，建模纹理和细粒度细节需要单独处理，对抗方法可能更适合。我将在下文详细讨论。<br>训练大型强大扩散模型计算密集，使用更紧凑的潜在空间可避免处理笨重的输入表征，有助于减少内存需求，加快训练和采样速度。<br>早期确实有工作尝试端到端方法，联合学习潜在表征和扩散先验，但未流行。尽管从实用角度看，避免多阶段训练的序列依赖是可取的，但感知和计算优势使这些麻烦值得。<br>为什么需要两个阶段？<br>如前所述，确保感知信号的生成模型能够高效利用其容量至关重要，因为这能使它们更具成本效益。这基本上就是两阶段方法所实现的目标：通过提取更紧凑的表征，专注于信号内容中与感知相关部分，并对这一表征进行建模而非原始表征，我们能够使相对较小的生成模型发挥超越其规模的效果。<br>大多数感知信号中的信息实际上在感知上并不重要，这并非新发现：这也是有损压缩背后的关键思想，它使我们能够以更低的成本存储和传输这些信号。像JPEG和MP3这样的压缩算法利用了信号中的冗余以及我们对低频比高频更敏感的事实，从而用更少的比特表征感知信号。（还有其他感知效应，例如听觉掩蔽，但非均匀的频率敏感性是最重要的。）<br>那么，我们为什么不以这些有损压缩技术为基础来构建生成模型呢？这并非一个坏主意，一些研究确实为此目的使用了这些算法或其部分组件。但我们很自然地倾向于用更多的机器学习来解决问题，看看是否能超越这些“手工设计”的算法。<br>这不仅仅是机器学习研究者的自大：实际上，使用学习得到的潜在表征而非预先存在的压缩表征有一个非常好的理由。与压缩设置不同，在压缩设置中越小越好，尺寸是唯一重要的因素，生成建模的目标还施加了其他约束：某些表征比其他表征更容易建模。至关重要的是，表征中保留了一些结构，我们可以通过赋予生成模型适当的归纳偏置来加以利用。这一要求在重建质量和潜在表征的可建模性之间创造了权衡，我们将在下一节中探讨这一点。<br>潜在表征有效性的另一个重要原因是它们如何利用我们感知在不同尺度上不同工作的事实。在音频领域，这一点显而易见：幅度的快速变化会产生音高的感知，而在较粗时间尺度上的变化（例如鼓点）则可以被单独辨别。鲜为人知的是，这种现象在视觉感知中也扮演着重要角色：颜色和强度的快速局部波动被感知为纹理。我曾在Twitter上尝试解释这一点，并在此处改写该解释：<br>一种思考方式是纹理与结构的对比，或者有时人们称之为东西与物体的对比。<br>在一张狗在田野中的图像里，草的纹理（东西）是高熵的，但我们不善于感知这种纹理各个实例间的差异，我们只是将其感知为不可数的「草」。我们无需逐一把每一根草叶看在眼里，就能确定我们看到的是田野。<br>这种纹理的实现如果稍有不同，我们通常无法察觉，除非把图像直接叠在一起。用对抗自编码器做实验很有趣：当把原始图像和重建图像并排放在一起比较时，它们往往看起来一模一样。但如果把它们叠在一起，来回切换查看，常常会发现图像之间的差异，尤其是在纹理丰富的区域。<br>对于物体（有形的东西）来说，情况则不同，例如狗的眼睛，类似程度的差异会立刻显现出来。一个好的潜在表征会抽象化纹理，但尽量保留结构。这样一来，在重建中对草纹理的表现可以与原始不同，而不会明显影响重建的保真度。这使得自编码器能够舍弃许多模式（即同一纹理的其他表现形式），并在其潜在空间中更简洁地表征该纹理的存在。<br>这反过来也应该使潜在空间中的生成建模变得更容易，因为它现在可以对纹理的有无进行建模，而无需捕捉与该纹理相关的所有复杂变化。<br>一张狗在田野中的图片。图片的上半部分熵值很低：组成天空的像素可以从其相邻像素中很容易地预测出来。而下半部分熵值很高：草地的纹理使得附近的像素很难被预测。<br>由于两阶段方法提供的显著效率提升，我们似乎愿意忍受它带来的额外复杂性——至少目前是这样。这种效率的提升不仅使训练运行更快、更便宜，而且更重要的是，它还可以大大加速采样。对于执行迭代细化的生成模型来说，这种显著的成本降低非常受欢迎，因为生成单个样本需要多次通过模型进行前向传播。<br>权衡重建质量和可建模性<br>深入探讨有损压缩和潜在表征学习之间的差异是值得的。虽然机器学习可以用于两者，但如今广泛使用的大多数有损压缩算法并没有使用机器学习。这些算法通常基于率失真理论，该理论形式化并量化了我们能够压缩信号的程度（率）与我们允许解压缩信号与原始信号偏离的程度（失真）之间的关系。<br>对于潜在表征学习，我们可以通过引入可建模性或可学习性的概念来扩展这种权衡，该概念描述了生成模型捕捉这种表征分布的难度。这导致了一个三方的率失真可建模性权衡，这与Tschannen等人在表征学习的背景下讨论的率失真有用性权衡密切相关。（在机器学习背景下，另一种流行的扩展这种权衡的方式是率失真感知权衡，它明确区分了重建保真度和感知质量。为了避免过于复杂，我在这里不会做这种区分，而是将失真视为在感知空间中测量的量，而不是输入空间。）<br>为什么这甚至是一个权衡并不立即显而易见——为什么可建模性与失真相冲突？要理解这一点，考虑有损压缩算法的工作方式：它们利用已知的信号结构来减少冗余。在这个过程中，这种结构通常从压缩表征中被移除，因为解压缩算法能够重建它。但输入信号中的结构也在现代生成模型中被广泛利用，例如以架构归纳偏差的形式，这些偏差利用信号属性，如平移等变性或频率谱的特定特征。<br>如果我们有一个神奇的算法，能够高效地从输入信号中移除几乎所有冗余，我们将使生成模型捕捉压缩信号中剩余的无结构变异性变得非常困难。如果我们的目标仅仅是压缩，这是完全可以的，但如果我们要进行生成建模，就不是这样了。因此，我们必须找到一个平衡：一个好的潜在表征学习算法会检测并移除一些冗余，但同时也会保留一些信号结构，以便为生成模型留下一些可以利用的东西。<br>在这种情况下，一个不好的例子是熵编码，它实际上是一种无损压缩方法，但也被用作许多有损方案的最后阶段（例如JPEG&#x2F;PNG中的霍夫曼编码，或H.265中的算术编码）。熵编码算法通过为频繁出现的模式分配更短的表征来减少冗余。这并没有移除任何信息，但它破坏了结构。因此，输入信号中的小变化可能导致相应的压缩信号发生更大的变化，从而使熵编码序列的建模难度大大增加。<br>相比之下，潜在表征倾向于保留大量的信号结构。下面的图展示了一些图像的StableDiffusion潜在表征的可视化（取自EQ-VAE论文）。仅通过视觉检查潜在表征，就可以很容易地识别出动物。它们基本上看起来像是带有扭曲颜色的噪声低分辨率图像。这就是为什么我喜欢将图像潜在表征视为仅仅是「高级像素」，捕捉了一些普通像素不会捕捉的额外信息，但大部分仍然像像素一样表现。<br>从几幅图像中提取的StableDiffusion潜在表征的可视化，取自EQ-VAE论文。潜在空间的前三个主成分分别对应于颜色通道。从潜在表征的视觉检查中，图像中的动物仍然大多可以被识别出来，这表明编码器保留了大量原始信号的结构。<br>可以说，这些潜在表征相当低层次。传统的变分自编码器（VAE）会将整个图像压缩成一个特征向量，通常会得到一个能够进行语义操作的高级表征，而现代用于图像生成建模的潜在表征实际上更接近像素层面。它们具有更高的容量，继承了输入的网格结构（尽管分辨率较低）。网格中的每个潜在向量可能会抽象掉一些低层次的图像特征，例如纹理，但它并没有捕捉到图像内容的语义。这也是为什么大多数自编码器并不使用任何额外的条件信号，例如文字描述，因为这些信号主要约束的是高层次的结构（尽管也有例外）。<br>可控性<br>两个关键的设计参数控制着具有网格结构的潜在空间的容量：下采样因子和表征的通道数。如果潜在表征是离散的，码本大小也很重要，因为它对潜在表征能够包含的信息位数施加了一个硬性限制。（除了这些，正则化策略也起着重要作用，但我们将在下一节讨论它们的影响。）<br>以一个示例来说，编码器可能会接收一张256×256像素的图像作为输入，并生成一个带有8个通道的32×32连续潜在向量网格。这可以通过使用跨步卷积堆栈或补丁大小为8的视觉转换器（ViT）来实现。降采样因子会同时降低宽度和高度方向的维度，因此潜在向量的数量比像素少64倍——但每个潜在向量有8个分量，而每个像素只有3个（RGB）。<br>总体而言，潜在表征的张量组件数量（即浮点数）比表征原始图像的张量少。我喜欢将这个数字称为张量尺寸缩减因子（TSR），以避免与空间或时间降采样因子混淆。<br>展示文本中描述的输入和潜在维度的示意图。<br>如果我们把编码器的下采样因子增加2倍，潜在网格的大小就会变成16×16，然后我们可以把通道数增加4倍到32个通道，以保持相同的TSR（总空间冗余）。对于给定的TSR，通常有几种不同的配置在重建质量方面表现得大致相当，尤其是在视频的情况下，我们可以分别控制时间和空间的下采样因子。然而，如果我们改变TSR（通过改变下采样因子而不改变通道数，或者反之），这通常会对重建质量和可建模性产生深远的影响。<br>从纯数学角度来看，这是令人惊讶的：如果潜在变量是实值的，网格的大小和通道的数量就不应该有关系，因为单个数字的信息容量已经是无限的（这被Tupper的自指公式巧妙地证明了）。但当然，有一些实际的限制因素限制了潜在表征的单个组成部分能够携带的信息量：<br>我们使用浮点数来表征实数，而浮点数的精度是有限的；<br>在许多公式中，编码器会添加一定量的噪声，这进一步限制了有效的精度；<br>神经网络并不擅长学习其输入的高非线性函数。<br>第一个原因显而易见：如果用32位（单精度）来表征一个数字，那么它最多也只能传递32位的信息。加入噪声会进一步减少可用的位数，因为一些低位数字会被噪声掩盖。<br>最后一个限制其实更为严格，但目前理解还不够充分：难道神经网络不就是为了学习非线性函数吗？确实如此，但神经网络天然倾向于学习相对简单的函数。这通常是一个优点，而不是缺点，因为它增加了学习到的函数能够泛化到未见数据的概率。但如果我们要把大量信息压缩到几个数字中，这很可能需要高度的非线性。虽然有一些方法可以帮助神经网络学习更复杂的非线性函数（例如傅里叶特征），但在我们的场景中，高度非线性的映射实际上会对可建模性产生负面影响：它们会掩盖信号结构，因此这不是一个好的解决方案。具有更多组件的表征会提供更好的权衡。<br>同样的道理也适用于离散潜在表征：离散化对表征的信息内容设定了一个硬性上限，但是否能够高效地利用这一容量主要取决于编码器的表达能力以及量化策略在实际中的效果（即是否通过尽可能均匀地使用不同码字来实现高码本利用率）。目前最常用的仍然是VQ-VAE中的原始VQ瓶颈，但最近一种通过「旋转技巧」提供更好梯度估计的改进方法在码本利用率和端到端性能方面似乎很有前景。一些不使用显式学习码本的替代方案也逐渐受到关注，例如有限标量量化（FSQ）、无查找量化（LFQ）和二进制球面量化（BSQ）。<br>总结来说，选择合适的TSR（总空间冗余）至关重要：更大的潜在表征能够带来更好的重建质量（更高的率，更低的失真），但可能会对可建模性产生负面影响。更大的表征意味着有更多的信息位需要建模，因此需要生成模型具备更高的容量。在实践中，这种权衡通常是通过经验来调整的。这可能是一个成本较高的过程，因为目前还没有任何可靠且计算成本低的可建模性代理指标。因此，需要反复训练足够大的生成模型才能得到有意义的结果。<br>Hansen-Estruch等人最近对潜在空间容量及其各种影响因素进行了广泛的探索（他们的关键发现已在文中明确突出显示）。目前有一个趋势是增加空间下采样因子，并相应地增加通道数以保持TSR，以便在更高分辨率下进行图像和视频生成（例如LTX-Video中的32×、GAIA-2中的44×，以及DCAE中的64×）。<br>梳理和塑造潜在空间<br>到目前为止，我们已经讨论了潜在表征的容量，即应该在其中包含多少位信息。同样重要的是，要精确控制原始输入信号中的哪些位信息应该被保留在潜在表征中，以及这些信息是如何呈现的。我将前者称为梳理潜在空间，后者称为塑造潜在空间——这种区分虽然微妙，但很重要。许多正则化策略已经被设计出来，用于塑造、梳理和控制潜在表征的容量。我将专注于连续情况，但其中许多考虑同样适用于离散潜在表征。<br>VQGAN与KL正则化潜变量<br>Rombach等人提出了两种针对连续潜在空间的正则化策略：<br>遵循原始VQGAN的设计理念，并将量化步骤重新解释为解码器的一部分（而非编码器的一部分），从而获得连续潜在表征（即VQ正则化，VQ-reg）；<br>完全移除VQGAN中的量化操作，转而像标准变分自编码器（VariationalAutoencoder，VAE）那样引入KL散度惩罚项（即KL正则化，KL-reg）。<br>这种只对VQGAN作出最小改动、以适配扩散模型（DiffusionModel）而生成连续潜变量的思路可谓巧妙：此类结构在自回归模型（AutoregressiveModel）中表现良好，而训练过程中的量化步骤也起到了某种「安全阀」作用，防止潜变量携带过多的信息。<br>然而，正如我们之前所讨论的，这种机制在多数情况下可能并非真正必要，因为编码器的表达能力往往才是生成模型性能的瓶颈所在。<br>相比之下，KL正则化本身是传统VAE架构的核心组成部分：它是构成证据下界（EvidenceLowerBound，ELBO）的两项损失之一。ELBO是对数据似然的下界，用于间接地、但在数值上可行地最大化样本的对数似然。该项正则化鼓励潜变量服从某一预设先验分布（通常为高斯分布）。<br>但关键在于，ELBO仅在KL项前未引入缩放超参数（scaleparameter）的前提下，才是真正意义上的似然下界。然而在实际应用中，为了训练稳定性及重建质量的考虑，KL正则项几乎总是被大幅缩放（通常缩小几个数量级），这几乎切断了它与变分推断原始语境之间的联系。<br>造成这一调整的原因也很直接：未经缩放的KL项具有过强的限制作用，会显著压缩潜在空间的容量，继而严重影响图像重建质量。出于工程可行性上的考虑，业界普遍的做法是显著降低其在总损失函数中的权重。<br>（顺便提一下：在某些更关注语义可解释性或潜变量解耦（disentanglement）质量、而非重建效果的任务中，增加KL权重也是一种有效且常见的策略，例如β-VAE）。<br>接下来属于明显的主观观点，但我认为当前关于KL项效果的讨论中还存在相当多的“神秘化思维”。例如，KL项被广泛认为能引导潜变量服从高斯分布——然而在实际应用中的缩放因子下，这一效果微弱到几乎可以忽略。即使是在“真正的”VAE中，总体后验分布（aggregateposterior）也很少呈现出标准高斯形态。<br>因此，在我看来，「VAE」中那个「V」（即「Variational」，变分）如今几乎已失去实质意义——其存在意义更多是历史遗留。与其如此，我们倒不如将这类模型称为「KL正则化自编码器」（KL-regularisedautoencoders），这在概念上对当前主流实践更贴切。<br>在这种设定下，KL项最主要的作用，是抑制潜变量分布中的离群点，并在一定程度上约束其数值尺度。换句话说：尽管KL项通常被当作限制潜变量容量的机制来阐述，其在现实中起到的作用，更多是对潜变量形状的轻度限制——而这种限制也远没有想象中那么强。<br>调整重建损失</p>
<p>然而，值得进一步研究的是，这些损失项如何影响潜在变量（latents），特别是在「内容筛选」（curation，即潜变量学会编码哪些信息）方面的作用。如第3节（为什么需要两个阶段？）所讨论的，在视觉领域中，一个良好的潜在空间应在一定程度上实现对纹理的抽象（abstraction）。这些损失是如何帮助实现这一目标的？<br>一个有启发性的思维实验是，假设我们将感知损失和对抗损失去除，仅保留回归损失，如传统的变分自编码器（VAE）所采用的做法。这种设置通常会导致模糊的重建结果。回归损失在设计上不会偏向于特定类型的信号内容，因此在图像任务中，往往会更关注于低频信息，原因仅仅是这种信息在图像中占比较大。<br>在自然图像中，不同空间频率的能量通常与其频率的平方成反比——频率越高，能量越小（有关该现象的图示分析，请参阅我先前的博文）。由于高频成分在总信号能量中所占比例极小，因此使用回归损失时，模型更倾向于准确地预测低频分量，而非高频部分。<br>然而，从人类感知的角度看，高频信息的主观重要性远远高于它们在信号能量中所占的比例，这也就导致了大家熟知的「模糊感」重建结果。<br>图片来自VQGAN论文。与仅使用回归损失训练的DALL-EVAE的对比展示了感知与对抗损失所带来的显著影响。<br>由于纹理主要由这些高频成分构成，而回归损失几乎忽略这些高频信息，最终我们得到的潜在空间不仅无法做出纹理抽象，反而是直接抹去了与纹理相关的信息。从感知质量的角度讲，这是一种很差的潜在空间结构。这也直接说明了感知损失与对抗损失的重要性：它们确保潜在变量中能够编码一定的纹理信息。<br>既然回归损失具有上述这些不理想的性质，并且往往需要其他损失项来加以弥补，那我们是否可以干脆将其完全舍弃呢？事实证明，这种做法也不可行。因为感知损失与对抗损失的优化过程更为复杂，且容易陷入病态的局部最优解（毕竟，这些损失通常是基于预训练神经网络构建的）。在训练过程中，回归损失起到某种「正则化器」的角色，持续为优化过程提供约束与指引，避免模型陷入错误的参数空间。<br>当前已有诸多策略尝试采用不同形式的重建损失，以下仅列举部分文献中的实例，展示该方向的多样性：<br>前文提到的DCAE46模型，其方法在整体上与原始的VQGAN配方差异不大，只是将L2回归损失（均方误差，MSE）替换为L1损失（平均绝对误差，MAE）。它依然保留了LPIPS感知损失（LearnedPerceptualImagePatchSimilarity）以及PatchGAN49判别器。该方法的不同之处在于其采用了多阶段训练，仅在最后阶段启用对抗损失。<br>ViT-VQGAN50模型结合了两种回归损失：L2损失与logit-Laplace损失51，并使用StyleGAN52判别器以及LPIPS感知损失。</p>
<p>正如经典菜肴千人千味，在这种「配方」问题上，每位研究者都有各自的解法！<br>表征学习vs重建<br>此前我们探讨的诸多设计选择，不仅影响重建质量，同时也深刻影响所学习的潜在空间的性质。其中，重建损失事实上承担了双重任务：既保证了解码器输出的高质量，又在潜在空间的形成中发挥了关键作用。这不禁引出一个问题：像我们现在这样「一石二鸟」的做法，真的合适吗？我认为答案是否定的。<br>一方面，为生成建模（generativemodelling）学习出良好且紧凑的表征；另一方面，将这一表征解码回原始输入空间，这其实是两项截然不同的任务。而现代自动编码器通常被期望能同时完成这两项任务。<br>尽管从实践角度看，这种做法效果相当不错，无疑也简化了流程（毕竟自动编码器训练已经是完整系统中第一阶段的训练部分，我们自然希望尽可能避免进一步复杂化，尽管训练多个阶段的自动编码器也并非闻所未闻。但这一方法实则混淆了两个任务，其间某些适用于一个任务的设计，或许在另一个任务上并不理想。<br>当解码器采用自回归架构时，这种任务合并的问题尤为突出，因此我们提出使用一个独立的非自回归（non-autoregressive）辅助解码器（auxiliarydecoder）来为编码器提供学习信号。<br>主解码器（maindecoder）则完全不会影响潜在表征，因为其梯度在训练中不会反传至编码器。这使其专注于优化重建质量，而辅助解码器则承担起潜在空间的塑造任务。整个自动编码器各组件仍可联合训练，因此增加的训练复杂度非常有限。虽然辅助解码器会增加训练成本，但它在训练完成后即可被舍弃。<br>这种带有两个解码器的自动编码器结构中：主解码器仅用于重建，其梯度不回传到编码器（通常我们用虚线来表示这一点）辅助解码器则专注于构建潜在空间，它可以采用不同的架构、优化不同的损失函数，或者两者兼而有之。<br>尽管我们在那篇论文中使用自回归解码器来处理像素空间的想法，如今已经不再适用（可以说很不合时宜），但我仍然相信将表征学习与重建任务分开的这一策略在当前仍具有高度相关性。<br>一个辅助解码器，如果它优化的是另一种损失，或者采用了与主解码器不同的架构（抑或两者兼具），就可能为表征学习提供更有效的训练信号，从而带来更优的生成建模效果。<br>Zhu等人最近也得出了同样的结论（见其论文第2.1节），他们使用K-means对DINOv2提取的特征进行离散化建模，并结合一个单独训练的解码器。在生成建模中复用自监督学习（self-supervisedlearning）得到的表征，这一思路在音频建模领域早已较为普遍——可能是因为音频领域研究者原本就习惯于训练声码器（vocoder），将预定义的中间表征（例如梅尔频谱图）转换回波形信号。<br>通过正则化提升模型能力<br>对潜在变量容量的塑造、梳理和限制都会影响其可建模性：<br>容量限制决定了潜在变量中的信息量。容量越高，生成模型就必须越强大，才能充分捕捉其包含的所有信息；<br>塑造对于实现高效建模至关重要。相同的信息可以用多种不同的方式表征，有些方式比其他方式更容易建模。缩放和标准化对于正确建模至关重要（尤其是对于扩散模型而言），但高阶统计量和相关结构也同样重要；<br>梳理会影响可建模性，因为某些类型的信息比其他类型的信息更容易建模。如果潜在变量编码了输入信号中不可预测的噪声信息，那么它们的可预测性也会降低。<br>以下是一条有趣的推文，展示了这如何影响稳定扩散XLVAE：<br>图源：https :&#x2F;&#x2F;x.com&#x2F;rgilman33&#x2F;status&#x2F;1911712029443862938<br>在这里，我想将其与Xuetal.提出的V-information联系起来，它扩展了互信息的概念，使其能够考虑计算约束。换句话说，信息的可用性取决于观察者辨别信息的计算难度，我们可以尝试量化这一点。如果一条信息需要强大的神经网络来提取，那么输入中的V-information量就会低于使用简单线性探测的情况——即使以比特为单位的绝对信息量相同。<br>显然，最大化潜在表征的V-information量是可取的，以便最大限度地降低生成模型理解潜在表征所需的计算需求。我之前提到的Tschannenetal.描述的速率-失真-实用性权衡也支持同样的结论。<br>如前所述，KL惩罚对高斯化或平滑潜在空间的作用可能不如许多人认为的那么大。那么，我们可以做些什么来使潜在模型更容易建模呢？<br>使用生成先验：与自动编码器共同训练一个（轻量级）潜在生成模型，并通过将生成损失反向传播到编码器中，使潜在模型易于建模，就像在LARP或CRT中一样。这需要仔细调整损失权重，因为生成损失和重构损失相互矛盾：当潜在模型完全不编码任何信息时，它们最容易建模！<br>使用预训练的表征进行监督：鼓励潜在模型对现有高质量表征（例如DINOv2特征）进行预测，就像在VA-VAE、MAETok或GigaTok中一样。<br>鼓励等变性：使输入的某些变换（例如重缩放、旋转）产生相应的潜在表征，这些表征也进行类似变换，就像在AuraEquiVAE、EQ-VAE和AF-VAE中一样。我在第4部分中使用的EQ-VAE论文中的图表展示了这种约束对潜在空间的空间平滑度产生的深远影响。Skorokhodovetal.基于潜在空间的谱分析得出了相同的结论：等变性正则化使潜在谱与像素空间输入的谱更相似，从而提高了可建模性。<br>这只是一些可能的正则化策略的一小部分，所有这些策略都试图以某种方式增加潜在向量的V-information。<br>向下扩散<br>一类用于学习潜在表征的自编码器值得深入研究：带有扩散解码器的自编码器。虽然更典型的解码器架构采用前馈网络，该网络在一次前向传递中直接输出像素值，并且采用对抗式训练，但一种越来越流行的替代方案是使用扩散来完成潜在解码任务以及对潜在表征的分布进行建模。这不仅会影响重构质量，还会影响学习到的表征类型。<br>SWYCC、ϵ-VAE和DiTo是近期一些探索这种方法的研究成果，它们从几个不同的角度阐述了这一方法：<br>使用扩散解码器学习的潜在特征提供了一种更具原则性、理论基础的层级生成建模方法；<br>它们可以仅使用MSE损失进行训练，这简化了过程并提高了鲁棒性（毕竟对抗性损失的调整相当棘手）；<br>将迭代改进的原理应用于解码可以提高输出质量。<br>我无法反驳这些观点，但我确实想指出扩散解码器的一个显著弱点：它们的计算成本及其对解码器延迟的影响。我认为，目前大多数商业部署的扩散模型都是潜在模型的一个关键原因是：紧凑的潜在表征有助于我们避免在输入空间进行迭代细化，而这种做法既慢又贵。在潜在空间中执行迭代采样过程，然后在最后通过一次前向传播回到输入空间，速度要快得多。考虑到这一点，在我看来，在解码任务中重新引入输入空间迭代细化，在很大程度上违背了两阶段方法的初衷。如果我们要付出这样的代价，不妨选择一些简单的扩散方法来扩展单阶段生成模型。<br>你可能会说，别急——我们难道不能使用众多扩散蒸馏方法来减少所需的步骤数吗？在这样的设置中，由于具有非常丰富的条件信号（即潜在表征），这些方法确实被证明是有效的，甚至在单步采样机制下也是如此：条件越强，获得高质量蒸馏结果所需的步骤就越少。<br>DALL-E3的一致性解码器就是一个很好的实践案例：他们重用了稳定扩散潜在空间，并训练了一个基于扩散的新解码器，然后通过一致性蒸馏将其精简为仅两个采样步骤。虽然在延迟方面，它的开销仍然比原始对抗解码器更高，但输出的视觉保真度得到了显著提升。<br>DALL-E3基于StableDiffusion潜在空间的一致性解码器显著提高了视觉保真度，但代价是延迟更高。<br>Music2Latent是这种方法的另一个例子，它基于音乐音频的声谱图表征进行操作。它们的自编码器带有一致性解码器，采用端到端训练（不同于DALL-E3的自编码器，后者复用了预训练的编码器），并且能够一步生成高保真输出。这意味着解码过程再次只需要一次前向传递，就像对抗性解码器一样。<br>FlowMo是一款带有扩散解码器的自编码器，它使用后训练阶段来鼓励模式搜索行为。如前所述，对于解码潜在表征的任务，丢失模态以及专注于真实性而非多样性实际上是可取的，因为它需要的模型容量较少，并且不会对感知质量产生负面影响。对抗性损失往往会导致模态丢失，但基于扩散的损失则不会。这种两阶段训练策略使扩散解码器能够模拟这种行为——尽管仍然需要大量的采样步骤，因此计算成本远高于典型的对抗性解码器。<br>一些早期关于扩散自编码器的研究，例如Diff-AE和DiffuseVAE，更侧重于学习类似于老式VAE的高级语义表征，没有拓扑结构，并且注重可控性和解耦。DisCo-Diff介于两者之间，它利用一系列离散潜在表征来增强扩散模型，这些潜在表征可以通过自回归先验建模。<br>消除对抗训练的必要性无疑会简化事情，因此扩散自编码器在这方面是一个有趣（最近也相当流行）的研究领域。然而，在延迟方面，与对抗性解码器竞争似乎颇具挑战性，所以我认为我们还没有准备好放弃它们。我非常期待一个更新的方案：它不需要对抗性训练，但在视觉质量和延迟方面却能与当前的对抗解码器相媲美！<br>网格统治一切<br>感知模态的数字表征通常采用网格结构，因为它们是底层物理信号的均匀采样（和量化）版本。图像产生二维像素网格，视频产生三维网格，音频信号产生一维网格（即序列）。均匀采样意味着相邻网格位置之间存在着固定的量子（即距离或者时间量）。<br>从统计意义上讲，感知信号在时间和空间上也趋于近似平稳。与均匀采样相结合，这产生了丰富的拓扑结构，我们在设计用于处理它们的神经网络架构时会充分利用这种结构：使用广泛的权重共享来利用不变性和等变性等特性，这些特性通过卷积、循环和注意力机制来实现。<br>毫无疑问，对网格结构的利用正是我们能够构建如此强大的机器学习模型的关键原因之一。由此推论，在设计潜在空间时保留这种结构是一个绝佳的主意。我们最强大的神经网络设计在架构上依赖于它，因为它们最初就是为直接处理这些数字信号而构建的。如果潜在表征具有相同的结构，它们将更擅长处理这些表征。<br>网格结构也为学习生成潜在空间的自编码器带来了显著的优势：由于平稳性，并且它们只需要学习局部信号结构，因此可以在较小的裁剪图像或输入信号片段上进行训练。如果我们施加正确的架构约束（限制编码器和解码器中每个位置的感受野），它们将能够开箱即用地泛化到比训练时更大的网格。这有可能大大降低第一阶段的训练成本。<br>然而，事情并非总是那么美好：我们已经讨论过感知信号是如何高度冗余的，遗憾的是，这种冗余分布不均。信号的某些部分可能包含大量感知上显著的细节，而其他部分则几乎没有信息。在我们之前使用的田野里狗的图像中，考虑一个以狗的头部为中心的100×100像素块，然后将其与图像右上角仅包含蓝天的100×100像素块进行比较。<br>田野里的狗的图像，其中突出显示了两个具有不同冗余度的100×100像素块。<br>如果我们构建一个继承输入二维网格结构的潜在表征，并用它来编码这幅图像，则必然会使用完全相同的容量来编码这两个图像块。如果我们让表征足够丰富，能够捕捉到狗头所有相关的感知细节，那么将浪费大量容量来编码类似大小的天空图像块。换句话说，保留网格结构会显著降低潜在表征的效率。<br>这就是我所说的「网格统治一切」：我们用神经网络处理网格结构数据的能力已经非常成熟，偏离这种结构会增加复杂性，使建模任务变得更加困难，并且对硬件的兼容性也更差，所以通常不会这样做。但就编码效率而言，这实际上相当浪费，因为视听信号中感知显著的信息分布并不均匀。<br>Transformer架构实际上相对适合对抗这种统治：虽然我们通常将其视为序列模型，但它实际上是为处理集值（set-valued）数据而设计的，任何将集合元素相互关联的附加拓扑结构都通过位置编码来表达。这使得偏离常规网格结构比卷积或循环架构更为实用。几年前，我和同事探索了使用可变速率离散表征进行语音生成的这个想法。在两阶段生成模型的背景下，放松潜在空间的拓扑结构似乎最近越来越受到关注，包括如下：<br>TiTok和FlowMo从图像中学习序列结构化的潜在表征，将网格维度从二维降低到一维。大型语言模型的发展为我们带来了极其强大的序列模型，因此这是一种合理的目标结构；<br>One-D-Piece和FlexTok也采用了类似的方法，但使用了嵌套的dropout机制，在潜在序列中引入了由粗到细的结构。这使得序列长度能够根据每个输入图像的复杂度以及重建所需的细节级别进行调整。CAT也探索了这种自适应性，但仍然保留了二维网格结构，并且仅调整其分辨率；<br>TokenSet更进一步，使用了一种生成「token袋」的自动编码器，完全摒弃了网格。<br>除了CAT之外，所有这些方法的共同点在于：它们学习的潜在空间在语义上比我们目前主要讨论的那些要高级得多。就抽象层次而言，它们可能介于「高级像素」和老式VAE的矢量值潜在空间之间。FlexTok的一维序列编码器需要使用现有二维网格结构编码器的低级潜在空间作为输入，实际上是在现有低级潜在空间之上构建了一个额外的抽象层。TiTok和One-D-Piece也利用现有的二维网格结构潜在空间作为多阶段训练方法的一部分。一个相关的思路是：将语言域重用为图像的高级潜在表征。</p>
<p>其他模态的潜在变量<br>到目前为止，我们主要关注视觉领域，仅在一些地方简要提及音频。这是因为学习图像的潜在特征是我们已经非常擅长的事情，而且近年来，使用两阶段方法的图像生成已经得到了广泛的研究并投入生产！。我们在感知损失方面拥有成熟的研究体系，以及大量的判别器架构，使对抗训练能够专注于感知相关的图像内容。<br>对于视频，我们仍然停留在视觉领域，但引入了时间维度，这带来了一些挑战。人们可以简单地重复使用图像的潜在特征并逐帧提取它们来获得潜在的视频表征，但这可能会导致时间伪影（例如闪烁）。更重要的是，它无法利用时间冗余。我认为我们用于时空潜在表征学习的工具还远远不够完善，而且目前人们对如何利用人类对运动的感知来提高效率的理解也不够深入。尽管视频压缩算法都利用运动估计来提高效率，但情况仍然如此。<br>音频也是如此：虽然两阶段方法已被广泛采用，但对于使其适用于这种模态所需的修改，似乎并未达成广泛的共识。如前所述，对于音频，更常见的做法是重用通过自监督学习习得的表征。<br>那么语言呢？语言并非感知模态，但两阶段方法或许也能提高大型语言模型的效率吗？事实证明，这并非易事。语言本质上比感知信号更难压缩：它作为一种高效的沟通方式发展起来，因此冗余度要低得多。但这并不意味着语言就不存在：香农曾有一个著名的估计：英语的冗余度为50%。但请记住，图像、音频和视频可以在相对较小的感知失真下压缩几个数量级，而语言则不可能在不丢失细微差别或重要语义信息的情况下做到这一点。<br>用于语言模型的Tokeniser往往是无损的（例如BPE、SentencePiece），因此生成的token通常不被视为「潜在token」（然而，ByteLatentTransformer在其动态tokenisation策略中确实使用了这种框架）。然而，语言中相对缺乏冗余并没有阻止人们尝试学习有损的高级表征！用于感知信号的技术可能无法沿用，但人们已经探索了几种其他用于学习句子或段落级别表征的方法。<br>端到端会是最后赢家吗？<br>当深度学习兴起时，主流观点是：我们将尽可能用端到端学习取代手工构建的特征。联合学习所有处理阶段将使这些阶段能够相互适应和协作，从而最大限度地提高性能，同时从工程角度简化流程。这或多或少也正是计算机视觉和语音处理领域最终发生的事情。从这个角度来看，颇具讽刺意味的是，当今感知信号的主流生成建模范式是两阶段方法。虽然两个阶段都倾向于学习，但并非完全端到端！<br>如今产品中部署的文本转图像、文本转视频和文本转音频模型大多使用中间潜在表征。值得思考的是，这种现状是暂时的，还是会持续下去？毕竟，两阶段训练确实引入了相当多的复杂性，除了更加优雅之外，端到端学习还可以帮助确保系统的所有部分都与单一的总体目标完美地保持一致。<br>如上所述，输入空间的迭代细化速度慢且成本高昂，我认为这种情况可能会持续一段时间——尤其是在我们不断提升生成信号的质量、分辨率和&#x2F;或长度的情况下。我们不太可能放弃潜在层在训练效率和采样延迟方面的优势，目前尚无可行的替代方案被证明能够大规模应用。这是一个颇具争议的观点，因为一些研究人员似乎认为是时候转向端到端方法了。我个人认为现在还为时过早。<br>那么，我们何时才能准备好回归单阶段生成模型呢？像简单扩散、AmbientSpaceFlow、Transformers和PixelFlow这样的方法已经证明：即使在相对较高的分辨率下，这种方法也能很好地发挥作用，只是目前还不够划算。但硬件正以惊人的速度不断改进和提升，因此我推测我们最终会达到一个临界点：即相对低效的输入空间模型在经济上优于工程复杂性日益增加的潜在空间模型。至于何时实现，则取决于具体模态、硬件改进的速度以及研究的进展，因此我不会做出具体的预测。<br>过去，我们需要潜在向量来确保生成模型专注于学习感知相关的信号内容，同时忽略视觉上不显著的熵。回想一下，输入空间中的似然损失在这方面尤其糟糕，而切换到在潜在空间中测量似然值可以显著改善基于似然模型的结果。可以说，这种情况已不再存在，因为我们已经找到了如何在感知上重新加权自回归和扩散模型的似然损失函数，从而消除了扩展的一个重要障碍。尽管如此，潜在空间模型的计算效率优势仍然一如既往地重要。<br>第三种替代方案，我目前为止只是简要提到过，是分辨率级联方法。这种方法不需要表征学习，但仍然将生成模型问题分解为多个阶段。一些早期的商业模型曾使用这种方法，但它似乎已经不再受欢迎了。我认为这是因为不同阶段之间的分工不够完善——上采样模型必须完成太多的工作，这使得它们更容易在各个阶段积累错误。<br>©THEEND<br>转载请联系本公众号获得授权<br>投稿或寻求报道：<a href="mailto:&#x6c;&#105;&#121;&#97;&#122;&#x68;&#111;&#x75;&#64;&#106;&#x69;&#113;&#105;&#122;&#104;&#x69;&#x78;&#105;&#x6e;&#x2e;&#99;&#111;&#x6d;">&#x6c;&#105;&#121;&#97;&#122;&#x68;&#111;&#x75;&#64;&#106;&#x69;&#113;&#105;&#122;&#104;&#x69;&#x78;&#105;&#x6e;&#x2e;&#99;&#111;&#x6d;</a></p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">ZejunCao</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://zejuncao.github.io/2025/05/06/1000003585-2650967676-3/">https://zejuncao.github.io/2025/05/06/1000003585-2650967676-3/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">ZejunCao</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/%E6%9C%BA%E5%99%A8%E4%B9%8B%E5%BF%83/">
                                    <span class="chip bg-color">机器之心</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2025/05/06/1000003585-2650967676-4/">
                    <div class="card-image">
                        
                        <img src="/medias/frontcover/1000003585_2650967676_4.jpg" class="responsive-img" alt="ICML 2025 | 注意力机制中的极大值：破解大语言模型上下文理解的关键">
                        
                        <span class="card-title">ICML 2025 | 注意力机制中的极大值：破解大语言模型上下文理解的关键</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2025-05-06
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            ZejunCao
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E6%9C%BA%E5%99%A8%E4%B9%8B%E5%BF%83/">
                        <span class="chip bg-color">机器之心</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2025/05/06/1000000478-2659284268-1/">
                    <div class="card-image">
                        
                        <img src="/medias/frontcover/1000000478_2659284268_1.jpg" class="responsive-img" alt="DeepSeek隐藏技巧，一句话直接导出Excel表格，自动搞定Word排版">
                        
                        <span class="card-title">DeepSeek隐藏技巧，一句话直接导出Excel表格，自动搞定Word排版</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2025-05-06
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            ZejunCao
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E7%A1%AC%E6%A0%B8AIGC/">
                        <span class="chip bg-color">硬核AIGC</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>



<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="/libs/aplayer/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2025</span>
            
            <a href="/about" target="_blank">ZejunCao</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            
            <br>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/ZejunCao" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:caozejun369@163.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1378463428" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1378463428" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>



    <a href="https://weibo.com/u/5915009280" class="tooltipped" target="_blank" data-tooltip="关注我的微博: https://weibo.com/u/5915009280" data-position="top" data-delay="50">
        <i class="fab fa-weibo"></i>
    </a>



    <a href="https://www.zhihu.com/people/Garfusion/posts" class="tooltipped" target="_blank" data-tooltip="关注我的知乎: https://www.zhihu.com/people/Garfusion/posts" data-position="top" data-delay="50">
        <i class="fab fa-zhihu1">知</i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    
    
    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
