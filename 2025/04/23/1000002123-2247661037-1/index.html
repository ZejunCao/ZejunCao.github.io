<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Wan2.1和HunyuanVideo文生视频模型算法解析与功能体验丨前沿多模态模型开发与应用实战第六期, ZejunCao&#39;Blogs">
    <meta name="description" content="Wan2.1和HunyuanVideo文生视频模型算法解析与功能体验丨前沿多模态模型开发与应用实战第六期

仅用于站内搜索，没有排版格式，具体信息请跳转上方微信公众号内链接

多模态生成大模型是一类能够同时创造和合成多种数据形式的人工智能系">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>Wan2.1和HunyuanVideo文生视频模型算法解析与功能体验丨前沿多模态模型开发与应用实战第六期 | ZejunCao&#39;Blogs</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    


    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    
        <link rel="stylesheet" type="text/css" href="/css/reward.css">
    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 7.3.0"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">ZejunCao&#39;Blogs</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">ZejunCao&#39;Blogs</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/frontcover/1000002123_2247661037_1.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Wan2.1和HunyuanVideo文生视频模型算法解析与功能体验丨前沿多模态模型开发与应用实战第六期</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/%E9%A3%9E%E6%A1%A8PaddlePaddle/">
                                <span class="chip bg-color">飞桨PaddlePaddle</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2025-04-23
                </div>
                

                

                

                

                
            </div>
        </div>
        <hr class="clearfix">

        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/hOChwIQgYegzQyzIIoOAvw">Wan2.1和HunyuanVideo文生视频模型算法解析与功能体验丨前沿多模态模型开发与应用实战第六期</a></p>
<blockquote>
<p>仅用于站内搜索，没有排版格式，具体信息请跳转上方微信公众号内链接</p>
</blockquote>
<p>多模态生成大模型是一类能够同时创造和合成多种数据形式的人工智能系统。这类模型基于前沿的生成式深度学习架构，不仅能理解跨模态信息，还能实现多形式内容的高质量生成与融合。近些年来，文生视频多模态大模型展现出强大的表现力，通过跨模态对齐与协同创作，可生成更丰富、连贯且符合场景逻辑的视频内容，极大拓展了创造性AI的应用边界。通过大规模Transformer架构与扩散式生成机制，这类模型实现了对视频生成质量，动态性，一致性的全面提升，广泛应用于虚拟场景合成，跨模态艺术设计、个性化内容生成等场景，为创意产业和智能化工具的发展注入全新动能。<br>上一期介绍了文生图的多模态扩散模型FLUX，本期将介绍Wan2.1模型和HunyuanVideo模型，涵盖文生视频，图片生视频等方面。内容包括模型细节、训练流程、模型能力的展示，并以PaddleMIX中Wan2.1和HunyuanVideo的实现为例，对代码进行逐步解读。<br>wan2.1生成效果展示<br>HunyuanVideo生成效果展示<br>引言<br>自OpenAI推出Sora以来，视频生成技术引起了业界和学术界的广泛关注，推动了该领域的快速发展。能够生成与专业制作内容相媲美的视频的模型的出现，大大提高了内容创作的效率，同时降低了视频制作的成本。<br>HunyuanVideo是一个13B参数量的视频生成模型，模型进行了一系列针对性的设计，保证了高质量的视觉效果，运动动力学，文本-视频对齐和更好的拍摄技术。论文提出了一套完整的数据过滤，数据筛选处理的流程，生成了大量高质量的视频数据用于模型训练。评测结果显示，HunyuanVideo超越了之前最先进的模型，包括RunwayGen-3,Luma1.6等。<br>Wan2.1的核心设计灵感来源于扩散变换器（DiT）与流匹配相结合的成功框架，该框架已在文本到图像（T2I）和文本到视频（T2V）任务中证明了通过扩展可实现显著的性能提升。在这一架构范式中，采用交叉注意力来嵌入文本条件，同时精心优化模型设计以确保计算效率和精确的文本可控性。为了进一步增强模型捕捉复杂动态的能力，还融入了完整的时空注意力机制。Wan2.1提供了两个功能强大的模型，即1.3B和14B参数模型，分别用于提高效率和效果。它还涵盖了多个下游应用，包括图像到视频、指令引导的视频编辑和个人视频生成，涵盖多达八个任务。同时，Wan2.1是首个能够生成中英文视觉文本的模型，显著提升了其实用价值。</p>
<p>Hunyuanvideo模型介绍<br>Hunyuanvideo方法介绍<br>模型架构<br>HunyuanVideo网络架构由3部分组成如下图所示，Causal3DVAE，LargeLanguageModels以及diffusionbackbone</p>
<p>HunyuanVideo中使用了FullAttention机制，具有如下的优势：<br>相比分离的spatio-temporalattention，具有更好的效果<br>支持同时生成图像和视频，简化了模型训练过程，提升了模型的可扩展性<br>能够更加高效地使用目前LLM相关的加速技术，提升了训练和推理的效率<br>数据处理<br>该部分主要介绍训练数据的处理流程。<br>数据筛选。使用PySceneDetect将原始视频切分为视频片段，使用VideoCLIP模型计算这些视频片段的embeddings，根据embeddings过滤掉相似度高的视频片段和重采样。定义了一系列过滤器用于过滤数据，包括：美学过滤器，光流过滤器，OCR过滤器，运动过滤器等，用于筛选出美学质量高，高动态性，清晰，不包括文本和字幕的视频片段。数据过滤pipeline如下所示，总共产生了5个数据集，对应着5个训练阶段，同时视频分辨率也在逐步增加。为了在最后一个阶段提升模型性能，论文构建了一个包括1M高质量视频片段的数据集，用于微调模型。<br>数据标注。开发了一个VisionLanguageModel(VLM)用于生成结构化的注释，包括：简短的描述、详细的描述、背景、风格、拍摄风格、光照、氛围。训练了一个相机运动分类器，能够预测14种不同的相机运动类型，有助于实现生成模型的摄像机移动控制能力。<br>模型训练<br>1.图像预训练：<br>第一阶段：使用低分辨率256px图像进行预训练，同时采用多比例训练multi-aspecttraining，能够有助于模型生成各种比例的图像，同时可以避免在图像预处理阶段裁剪操作导致的文本-图像不对齐的问题<br>第二阶段：使用更高分辨率512px图像进行训练，为了保证低分辨率图像的生成效果，采用混合尺度训练，也即同时将256px和512px图像混合后进行训练<br>2.视频-图像联合训练：<br>经过处理后的视频数据有不同的比例和长度，为了更加高效地使用这些数据，根据视频长度和比例将数据划分到不同的buckets中。由于每个bucket中token的数量都不一样，为此为每个bucket分配了一个最大的批次大小，以防止训练时超出显存的问题。训练之前，所有数据都会根据视频长度和比例被分配到最近的bucket中，训练时，每个rank都会随机从一个bucket中获取一个批次的数据。这种随机选择机制可以保证模型训练的每一步都是用不同的尺寸的数据，从而提升模型的泛化能力。<br>为了生成更高质量的长视频，加快模型收敛，huyuanvideo提出了一种课程学习策略curriculumlearningstrategy，使用T2I模型权重进行初始化，随后逐步增加视频长度和分辨率，主要分为以下3个阶段：<br>低分辨率，短视频阶段：该阶段模型能够建立文本和视觉信息之间的基本映射关系，在较短的视频中可以保证一致性和连贯性<br>低分辨率，长视频阶段：该阶段模型学习更加复杂的时间动态和场景变换，能够在较长的视频中保证时间和空间的一致性<br>高分辨率，长视频阶段：该阶段模型主要增强视频分辨率和细节质量<br>同时，在每个阶段会按照不同的比例将图像数据加入进来，使用图像和视频的混合数据进行训练，从而解决高质量数据数据缺失的问题，进一步提升模型生成效果<br>3.提示词重写：用户提供的提示词的长度和风格往往差异较大，为此论文使用Hunyuan-Large模型作为提示词重写模型，将用户提供的prompt转换为model-preferredprompt。该方法可以在无需重新训练模型的前提下，利用详细的提示词和上下文学习样例来提升生成效果，主要功能如下：<br>多语言输入适配：该模块将通过各种语言处理和理解用户的prompt，确保保留prompt的含义和上下文信息<br>提示词结构标准化：将prompt重新组织为标准的格式，类似于训练数据的captions<br>复杂术语的简化：在保留用户原始含义的前提下，将用户复杂的用词简化为更简单直接的表达<br>4.高性能微调：在预训练阶段使用了大量的数据进行训练，虽然这些数据足够丰富但是质量参差不齐，为此论文从这些数据中精心挑选了4个特定的子集数据，并使用这些数据对模型进行微调，从而使模型可以生成更高质量，动态性的视频结果。在该阶段会随机开启或者关闭tiling策略，保证训练阶段和推理阶段结果的一致性。<br>模型加速<br>推理步数减少：之前的一些工作表明，去噪过程中前期的时间步尤为重要，为此hunyuanvideo会在使用较少推理步数时使用time-stepshifting，具体来说，当给定一个时间步t之后，会将其映射为，其中s表示偏移系数。当偏移系数s&gt;1时，模型会更加依赖前期的时间步，同时论文发现越少的推理步数需要越大的偏移系数s，例如50步时s设置为7，当推理步数减少到20步时s需要增大到17.<br>CFG蒸馏：Classifier-freeguidance(CFG)显著提升了文本引导生成模型的生成质量，但由于需要同时输入有条件输入和无条件输入，所以需要耗费更多的计算资源。为此hunyuanvideo使用了CFG蒸馏技术，具体来说，将CFG训练得到的模型视为教师模型，然后定义一个学生模型，该学生模型网络结构和初始化参数和教师模型一致，学生模型接收guidancescale作为输入参数，直接输出教师模型的CFG的结果。实验表明，CFG蒸馏后的学生模型不需要同时输入有条件输入和无条件输入，可以实现1.9倍的推理加速。<br>Hunyuanvideo代码解读<br>HunyuanVideoTransformerBlock<br>1.类名:HunyuanVideoTransformerBlock<br>2.主要功能:分两个stream对图像模态特征和文本模态特征进行计算<br>3.初始化参数(init):<br>num_attention_heads:attention时的head个数<br>attention_head_dim:attention时特征的维度<br>mlp_ratio:FFN中inner_dim扩大的比例<br>qk_norm:query和key的norm方式<br>4.前向传播参数(forward):<br>hidden_states:paddle.Tensor类型的输入张量，表示imageembeddings<br>encoder_hidden_states：paddle.Tensor类型的输入张量，表示promptembeddings<br>temb：paddle.Tensor类型的输入张量，表示timestepembeddings<br>attention_mask：可选参数，paddle.Tensor类型的注意力掩码，用于屏蔽不需要关注的位置。<br>freqs_cis：可选参数，由paddle.Tensor组成的Tuple类型，表示图像rotaryembeddings<br>5.前向传播(forward):<br>hidden_states输入AdaLayerNormZero，对hidden_states进行norm，shift，scale计算，并计算后续的gate，shift，scale参数</p>
<p>将hidden_states和encoder_hidden_states输入Attention模块<br>对不同模态的特征分别进行gate和残差计算<br>对不同模态的特征分别进行norm，scale，shift，MLP映射，gate，残差计算</p>
<p>HunyuanVideoSingleTransformerBlock<br>1.类名:HunyuanVideoSingleTransformerBlock<br>2.主要功能:深度融合图像和文本两种模态特征的信息<br>3.初始化参数(init):<br>num_attention_heads:attention时的head个数<br>attention_head_dim:attention时特征的维度<br>mlp_ratio:FFN中inner_dim扩大的比例<br>qk_norm:query和key的norm方式<br>4.前向传播参数(forward):<br>hidden_states:paddle.Tensor类型的输入张量，表示imageembeddings<br>encoder_hidden_states：paddle.Tensor类型的输入张量，表示promptembeddings<br>temb：paddle.Tensor类型的输入张量，表示timestepembeddings<br>attention_mask：可选参数，paddle.Tensor类型的注意力掩码，用于屏蔽不需要关注的位置。<br>image_rotary_emb：可选参数，由paddle.Tensor组成的Tuple类型，表示图像rotaryembeddings<br>5.前向传播(forward):<br>将hidden_states和encoder_hidden_states，也即两种模态的特征，进行拼接，得到新的特征hidden_states<br>hidden_states输入AdaLayerNormZeroSingle，对hidden_states进行norm，scale，shift计算，并计算后续的gate参数<br>将hidden_states分别输入Attention模块和MLP<br>将Attention模块输出和MLP映射后特征拼接，再进行gate，残差计算</p>
<p>HunyuanVideoRotaryPosEmbed<br>1.类名:HunyuanVideoRotaryPosEmbed<br>2.主要功能:生成时间、高度、宽度共3个方向的rotarypositionembeddings<br>3.初始化参数(init):<br>patch_size：int数据类型，高度和宽度方向上patch的尺寸<br>patch_size_t：int数据类型，时间维度上patch的尺寸<br>rope_dim：int数据类型组成的List，每个维度的位置编码的通道数<br>theta：float数据类型<br>4.前向传播参数(forward):<br>hidden_states：paddle.Tensor类型的输入张量，表示imageembeddings<br>5.前向传播(forward):<br>根据hidden_states的帧数，宽度和高度确定3个维度的位置编码尺寸<br>调用meshgrid方法生成3个维度的栅格grid<br>调用get_1d_rotary_pos_embed，输入3个维度的栅格grid，生成对应的rotarypositionembeddings<br>将rotarypositionembeddings的cos形式和sin形式矩阵分别取出，在attention时使用</p>
<p>HunyuanVideoTokenRefiner<br>1.类名:HunyuanVideoTokenRefiner<br>2.主要功能:<br>3.初始化参数(init):<br>in_channels：int数据类型，输入通道数<br>num_attention_heads：int数据类型，attention的head数量<br>attention_head_dim：int数据类型，attention的head的通道数<br>num_layers：int数据类型，token_refiner的数量<br>mlp_ratio：float数据类型，mlp层的通道压缩比例<br>mlp_drop_rate：float数据类型，mlp中dropout的比例<br>attention_bias：bool数据类型，是否开启attentionbias<br>4.前向传播参数(forward):<br>hidden_states：paddle.Tensor数据类型，表示promptembeddings特征<br>timestep：paddle.Tensor数据类型，时间步<br>attention_mask：可选参数，paddle.Tensor数据类型，attention操作的掩码<br>5.前向传播(forward):<br>使用attention_mask对hidden_states信息进行压缩，得到pooled_projections<br>调用CombinedTimestepTextProjEmbeddings，将pooled_projections和timestep信息进行融合，得到temb<br>使用Linear层对hidden_states进行映射<br>对hidden_states进行self-attention操作，进一步细化hidden_states的特征</p>
<p>Wan2.1模型介绍<br>方法介绍<br>数据处理<br>高质量数据对于训练大型生成式模型至关重要，而自动化的数据构建流程能够显著提升训练过程的效率。在开发数据集时，优先考虑了三个核心原则：高质量、高多样性和大规模。遵循这些原则，策划了一个包含数十亿视频和图像的数据集。<br>图1：不同训练阶段的数据配置。对于每个阶段，都会根据数据吞吐量动态调整与运动、质量和类别相关的数据比例。<br>1.PRE-TRAININGDATA<br>从内部版权来源和可公开访问的数据中策划并整理了一份候选数据集。在预训练阶段，目标是从这个庞大而嘈杂的数据集中选择高质量和多样化的数据，以促进有效的训练。在整个数据挖掘过程中，设计了一个四步数据清洗过程，重点关注基本维度、视觉质量和运动质量。<br>2.POST-TRAININGDATA<br>后训练的核心目标是通过高质量数据提高生成视频的视觉保真度和运动动态。本阶段数据处理流程对静态数据和动态数据采用不同的策略：图像数据经过优化以提高视觉质量，而视频数据则经过特殊处理以提高运动质量。<br>3.DENSEVIDEOCAPTION<br>虽然数据集包含许多图像和视频的原始网页文本描述，但它们往往过于简单，无法传达详细的视觉内容。DALL-E3已经证明，通过在高度描述性的生成视觉描述上进行训练，可以显著增强视觉生成模型遵循提示的能力。因此，开发了一个内部视频描述模型，为数据集中的每个图像和视频生成密集描述。为了训练这个模型，结合了开源视觉语言数据集和内部收集的其他数据。<br>4.MODELDESIGN<br>Architecture.<br>字幕模型采用LLaVA风格的架构。使用ViT编码器提取图像和视频帧的视觉嵌入。这些嵌入通过两层感知进行投影，然后输入到QwenLLM中。<br>对于图像输入，采用与LLaVA相同的动态高分辨率。图像最多可分为七个区块。对于每个区块，将视觉嵌入自适应池化为12x12网格表示，以减少计算量。<br>对于视频，每秒采样3帧，上限为129帧。为了进一步减少计算量，采用慢速-快速编码策略：每四帧保持原始分辨率，并对剩余帧的嵌入进行全局平均池化。对长视频基准的测试表明，慢速-快速机制可以在有限数量的视觉标记下增强理解上将性能从67.6%提高到69.1%），且无需字幕。<br>Training.<br>遵循最新的先进技术方法，训练过程分为三个阶段。<br>在第一阶段，冻结了ViT和LLM，并且只训练多层感知器来使视觉嵌入与LLM输入空间对齐，学习率设置为1e-3。<br>在第二阶段，所有参数均可训练。<br>在最后阶段，对一组包含高质量数据的小型数据集进行端到端训练。<br>对于最后两个阶段，LLM和MLP的学习率设置为1e-5，ViT的学习率设置为1e-6。<br>Wan-VAE<br>图2：Wan-VAE框架。Wan-VAE可以将视频的时空维度压缩4×8×8倍。橙色矩形代表2倍的时空压缩，绿色矩形代表2倍的空间压缩。<br>为实现高维﻿pixelspace﻿与低维﻿latentspace﻿的双向映射，Wan2.1设计了如图1所示的3DcausalVAE。给定输入视频﻿V∈R(1+T)×H×W×3，Wan-VAE将其时空维度压缩至﻿[1+T&#x2F;4,H&#x2F;8,W&#x2F;8]﻿，同时将channel数﻿C﻿扩展至16。具体地，首帧仅进行空间压缩（遵循MagViT-v2方法），以更好地处理图像数据。在架构层面，将所有GroupNorm层替换为RMSNorm层以保持时间因果关系。这一修改支持特征缓存机制，显著提升了推理效率。此外，在空间上采样层中将输入featurechannel减半，使推理阶段内存消耗降低33%。<br>通过进一步仔细调整基础通道的数量，Wan-VAE实现了仅包含1.27亿个参数的紧凑模型尺寸。这一优化减少了编码时间和内存使用量，从而有利于后续扩散变换器模型的训练。<br>训练Wan-VAE<br>采用三阶段方法训练Wan-VAE：<br>1.第一阶段：构建结构与2D图像VAE相同的模型，并在图像数据上预训练。<br>2.第二阶段：将训练好的2D图像VAE扩展为3D因果Wan-VAE，提供初始空间压缩先验（相比从零训练视频VAE，此方法大幅提升训练速度）。此阶段使用低分辨率（128×128）、少帧数（5帧）的视频训练，以加速收敛。训练损失包括L1重建损失、KL损失和LPIPS感知损失，权重系数分别为3、3e-6和3。<br>3.第三阶段：在高质量视频（不同分辨率和帧数）上微调模型，并引入基于3D判别器的GAN损失。<br>图3:特征缓存机制。（a）和（b）分别显示了如何在常规因果卷积和时间下采样中使用此机制<br>为实现对任意长度视频的高效编码与解码，在Wan-VAE的因果卷积模块中实现了特征缓存机制（featurecachemechanism）。具体而言：<br>1.输入格式与分块策略：视频序列的帧数遵循﻿1+T﻿的输入格式（首帧+后续T帧），因此将视频划分为﻿1+T&#x2F;4﻿个块（chunk），与潜在特征（latentfeatures）的数量一致。编码&#x2F;解码时，每个操作仅处理与单个潜在特征对应的视频块。根据时间压缩比例，每个处理块最多包含4帧，有效避免内存溢出。<br>2.时间连续性保障：<br>默认设置（无下采样）（图3a）：<br>因果卷积不改变帧数，需缓存历史块的最后2帧特征（卷积核大小为3）。<br>初始块用2个虚拟帧（zeropadding）初始化缓存；后续块复用前一块的最后2帧作为缓存，丢弃过时数据。<br>2倍时间下采样（图3b）：<br>仅在非初始块使用单帧缓存填充，确保输出序列长度严格符合下采样比例，同时维持块间因果性。<br>3.机制优势：<br>内存利用率优化：分块处理限制单次计算量，避免长视频导致的显存爆炸。<br>跨块特征一致性：缓存历史特征实现块间平滑过渡，支持无限长视频的稳定推理。<br>模型架构<br>图4：Wan模型架构<br>Wan模型基于当前主流的DiT（DiffusionTransformer）架构设计，主要由三个核心组件构成：<br>1.Wan-VAE：将输入视频﻿V∈R(1+T)×H×W×3从像素空间编码至潜在空间﻿x∈R1+T&#x2F;4×H&#x2F;8×W&#x2F;8。<br>2.DiffusionTransformer：接收潜在表示﻿x﻿，通过去噪过程生成目标视频的潜在特征。<br>3.TextEncoder：将输入文本转换为语义嵌入，指导视频生成内容。<br>Diffusiontransformer.主要由三个组件构成：一个﻿patchifying模块﻿，﻿transformerblocks﻿和一个﻿unpatchifying模块﻿。在每个块中专注于有效地建模时空上下文关系，并将文本条件与时间步长一起嵌入。实验验证该设计减少约25%参数量，并在相同参数量级下显著提升性能。<br>1.PatchifyingModule<br>使用核大小为(1,2,2)的3D卷积，并通过展平操作将输入x转换为形状为(B,L,D)的特征序列。<br>B：批大小（BatchSize）<br>L&#x3D;(1+T&#x2F;4)×H&#x2F;16×W&#x2F;16：序列长度（时间压缩后帧数×空间分块数）<br>D：潜在维度（LatentDimension）<br>2.TransformerBlocks<br>核心任务：建模时空上下文关系，并嵌入文本条件与时间步信息。<br>文本条件嵌入：采用交叉注意力机制，确保模型在长上下文建模中仍能遵循文本指令。<br>时间步调制：<br>使用共享MLP（含Linear层和SiLU激活层）处理时间嵌入，独立预测6个调制参数。<br>每个变换器块学习独特的偏置（Bias），增强表达能力。<br>3.UnpatchifyingModule：将变换后的序列特征还原至原始潜在空间维度。<br>图5:TransformerblockofWan.<br>4.Textencoder.Wan的架构采用umT5对输入文本进行编码。通过大量实验，发现umT5具有多个优势：<br>它拥有强大的多语言编码能力，能有效理解中文和英文，以及输入的视觉文本；<br>在相同条件下，发现umT5在组合方面优于其他单向注意力机制的LLM；<br>它表现出优异的收敛性，在相同参数规模下，umT5实现更快收敛。<br>基于这些发现，最终选择umT5作为文本嵌入器。<br>模型训练<br>利用流匹配框架为图像和视频领域建模了一个统一的去噪扩散过程。首先对低分辨率图像进行预训练，然后对图像和视频进行多阶段联合优化。在整个阶段中，图像视频联合训练通过使用逐步扩大的数据分辨率和延长的时间段来进行。<br>1.Imagepre-training.实验分析揭示了在高分辨率图像与长时长视频序列联合直接训练中的两个关键挑战：<br>扩展的序列长度（通常1280×720视频对应81帧）会显著降低训练吞吐量。在固定GPU-hour预算下，这导致数据吞吐不足，从而阻碍模型收敛速度。<br>过高的GPU内存消耗迫使使用次优batchsize，引发由梯度方差突增导致的训练不稳定。</p>
<p>3.Post-trainingconfigurations.在后训练阶段，保持与预训练阶段相同的模型架构和优化器配置，并使用预训练的检查点初始化网络。使用后训练视频数据集，以480像素和720像素的分辨率进行联合训练。<br>4.WorkloadAnalysis.在训练过程中，只有DiT模型得到优化，而文本编码器和VAE编码器保持冻结状态。因此，GPU内存使用主要集中在DiT的训练上。DiT的GPU内存使用可以表示为﻿γLbsh﻿，其中﻿γ﻿取决于DiT层的实现，﻿L﻿表示DiT层的数量。由于模型输入包括视频令牌、输入提示和时间步长，因此﻿γ﻿的值通常大于普通LLM模型。例如，虽然标准LLM的﻿γ﻿可能为34，但DiT模型的﻿γ﻿可能超过60。因此，当序列长度达到100万个令牌且微批量大小为1时，14BDiT模型中激活的总GPU内存使用量可能超过8TB。<br>5.DiTparallelstrategy.鉴于DiT模型的大小适中，并考虑到优化重叠计算和通信以及最大化数据并行（DP）的规模，选择FSDP作为参数分片策略。<br>6.Distributedstrategyswitchingfordifferentmodules.在训练过程中，不同模块利用相同的资源。具体而言，将数据并行（DP）应用于变分自编码器（VAE）和文本编码器，而DiT模块则结合使用数据并行（DP）和检查点并行（CP）。因此，当VAE和文本编码器的输出在训练过程中被馈送到DiT模块时，有必要切换分布式策略以避免资源浪费。具体而言，检查点并行（CP）要求CP组内的设备读取相同批次的数据。然而，如果VAE和文本编码器部分中的设备也读取相同的数据，则会导致冗余计算。为了消除这种冗余，CP组内的设备最初读取不同的数据。然后，在执行CP之前，执行一个大小等于CP大小的循环遍历，依次广播CP组内不同设备读取的数据，以确保CP内的输入相同。通过这种方式，单个模型迭代中VAE和文本编码器的时间比例减少到1&#x2F;CP，从而提高了整体性能。<br>Wan2.1代码解读<br>下面以PaddleMIX中Wan2.1的实现为例，对Wan2.1中关键创新点的代码实现进行讲解。<br>CausalConv3d<br>核心算子。<br>无限视频支持原理：通过cache_x缓存前一时间块的最后CACHE_T帧（代码中定义为2帧），在卷积时与当前块拼接，模拟完整时序上下文。<br>内存优势：显存占用仅与块大小相关（如处理1080P视频时每块4帧），而非全长视频，实现O(1)内存复杂度。</p>
<p>时-空解耦的渐进式下采样<br>以Downsample3d为例。</p>
<p>信息保留：缓存每一时间块的最后1帧（feat_cache[idx]&#x3D;x[:,:,-1:,:,:]），作为下一块的初始状态，避免时序断裂。</p>
<p>残差块中的跨块特征传递<br>层级缓存：每个残差块独立维护特征缓存，在卷积层间传递跨块信息。保证在长视频序列中前序信息的有效引入。</p>
<p>TransformerblockofWan<br>上述代码与图4结构一一对应，可以参照图5进行对照理解。</p>
<p>归一化层<br>归一化操作使用了RMS-norm</p>
<p>环境配置<br>若曾使用PaddlePaddle主页build_paddle_env.sh脚本安装PaddlePaddle，请根据本身cuda版本手动更新版本Installation（下方链接）。</p>
<p>安装ppdiffusers：ppdiffusers在目录下运行以下命令:<br>pythoninstall-e.﻿<br>硬件要求：<br>wan2.1模型：1.3B模型请保证有30G以上显存，14B模型请保证有80G显存<br>hunyuanvideo模型：最少需要50G以上显存<br>Wan2.1文本到视频<br>cdWan2.1pythontext2video.py﻿<br>可以通过text2video.py文件中的model_id参数选择模型，支持以下模型:<br>model_id当前支持:Wan-AI&#x2F;Wan2.1-T2V-14B-Diffusers,Wan-AI&#x2F;Wan2.1-T2V-1.3B-Diffusers<br>对应Wan2.1-T2V的14B版本与1.3B版本。<br>输出结果：在同一目录下，输出output.mp4文件，若没有修改prompt，视频长度为5s，视频内容为：一只猫和一只狗在厨房里一起烤蛋糕。猫在仔细地测量面粉，狗则在用木勺搅拌面糊。厨房里很舒适，阳光透过窗户洒进来。<br>Wan2.1图像到视频<br>pythonimage2video.py﻿<br>可以通过image2video.py文件中的model_id参数选择模型，支持以下模型:<br>model_id当前支持:Wan-AI&#x2F;Wan2.1-I2V-14B-480P-Diffusers,Wan-AI&#x2F;Wan2.1-I2V-14B-720P-Diffusers<br>对应Wan2.1-I2V14B的480P版本与720P版本。<br>输出结果：在同一目录下，输出output.mp4文件，若没有修改prompt，将会生成一个由图5为基础，符合文件内容描述：”一名宇航员在月球表面从一枚蛋中孵化，”，”背景实现了太空的黑暗和深度。高质量、超逼真的细节和令人屏息的电影镜头”。的一段5s视频。<br>Hunyuanvideo文本到视频<br>pythonppdiffusers&#x2F;examples&#x2F;inference&#x2F;text_to_video_generation-hunyuan_video.py﻿</p>
<p>总结<br>在文生视频领域，Wan2.1和Huyuanvideo凭借强大的网络架构和高质量数据，可以生成更丰富、高质量的视频。百度飞桨团队推出的PaddleMIX套件已支持模型的推理全流程，通过深入解析其代码实现，研究人员和开发者能够更透彻地理解模型的核心技术细节与创新。<br>论文链接：<br>Wan2.1TechnicalReport<br>https :&#x2F;&#x2F;arxiv.org&#x2F;abs&#x2F;2503.20314<br>HunyuanVideo:ASystematicFrameworkForLargeVideoGenerativeModels<br>https :&#x2F;&#x2F;arxiv.org&#x2F;abs&#x2F;2412.03603<br>项目地址：<br>Wan2.1<br>https :&#x2F;&#x2F;github.com&#x2F;PaddlePaddle&#x2F;PaddleMIX&#x2F;tree&#x2F;develop&#x2F;ppdiffusers&#x2F;examples&#x2F;Wan2.1<br>HunyuanVideo<br>https :&#x2F;&#x2F;github.com&#x2F;PaddlePaddle&#x2F;PaddleMIX&#x2F;tree&#x2F;develop&#x2F;ppdiffusers&#x2F;examples&#x2F;HunyuanVideo<br>为了帮助您通过解析代码深入理解模型实现细节与技术创新，基于PaddleMIX框架实操多模态文生视频模型Wan2.1和HunyuanVideo，我们将开展“多模态大模型PaddleMIX产业实战精品课”，带您实战操作多模态生成任务处理。4月28日正式开营，报名即可免费获得项目消耗算力（限时一周），名额有限，立即扫描下方二维码预约吧！<br>关注【飞桨PaddlePaddle】公众号<br>获取更多技术内容~</p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">ZejunCao</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://zejuncao.github.io/2025/04/23/1000002123-2247661037-1/">https://zejuncao.github.io/2025/04/23/1000002123-2247661037-1/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">ZejunCao</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/%E9%A3%9E%E6%A1%A8PaddlePaddle/">
                                    <span class="chip bg-color">飞桨PaddlePaddle</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2025/04/23/1000001391-2247509439-1/">
                    <div class="card-image">
                        
                        <img src="/medias/frontcover/1000001391_2247509439_1.jpg" class="responsive-img" alt="ELE AI算法大赛“赛道二：智慧骑士—消防隐患识别” Baseline">
                        
                        <span class="card-title">ELE AI算法大赛“赛道二：智慧骑士—消防隐患识别” Baseline</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2025-04-23
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            ZejunCao
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Coggle%E6%95%B0%E6%8D%AE%E7%A7%91%E5%AD%A6/">
                        <span class="chip bg-color">Coggle数据科学</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2025/04/23/1000000471-2659284063-1/">
                    <div class="card-image">
                        
                        <img src="/medias/frontcover/1000000471_2659284063_1.jpg" class="responsive-img" alt="豆包3.0生图效果太绝了，人人都能成为顶级设计师（附完整提示词）">
                        
                        <span class="card-title">豆包3.0生图效果太绝了，人人都能成为顶级设计师（附完整提示词）</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2025-04-23
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            ZejunCao
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E7%A1%AC%E6%A0%B8AIGC/">
                        <span class="chip bg-color">硬核AIGC</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>



<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="/libs/aplayer/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2025</span>
            
            <a href="/about" target="_blank">ZejunCao</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            
            <br>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/ZejunCao" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:caozejun369@163.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1378463428" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1378463428" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>



    <a href="https://weibo.com/u/5915009280" class="tooltipped" target="_blank" data-tooltip="关注我的微博: https://weibo.com/u/5915009280" data-position="top" data-delay="50">
        <i class="fab fa-weibo"></i>
    </a>



    <a href="https://www.zhihu.com/people/Garfusion/posts" class="tooltipped" target="_blank" data-tooltip="关注我的知乎: https://www.zhihu.com/people/Garfusion/posts" data-position="top" data-delay="50">
        <i class="fab fa-zhihu1">知</i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    
    
    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
